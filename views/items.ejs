<!-- Your Products Page (items.ejs) -->
<%- include('partials/top') -%>

<h1 style="color: #ffffff; font-weight: bold; text-align: center;">All Products!</h1>
<div class="product-container">
  <% items.forEach(item => { %>
    <div class="product">
      <div class="product-image">
        <img src="<%= item.image %>" alt="<%= item.name %>">
      </div>
      <div class="product-details">
        <h2><%= item.name %></h2>
        <br>
        <p style="    -webkit-text-stroke-width: 0.01px;    color:#007bff;    ">Price: $<%= item.price %></p>
        <!-- Updated Add to Cart form -->
        <form class="addToCartForm">
          <input type="hidden" name="name" value="<%= item.name %>">
          <input type="hidden" name="price" value="<%= item.price %>">
          <input type="hidden" name="image" value="<%= item.image %>">
          <button type="button" onclick="addToCart()" class="add-to-cart">
            Add to Cart
          </button>
        </form>
      </div>
    </div>
  <% }); %>
</div>

<%- include('partials/style') -%>
<%- include('partials/footer') -%>

<style>
  /* Paste the provided CSS styles here */

  /* Additional styles for cart page */
  #cart-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    margin: 20px auto;
  }

  .cart-list {
    width: 100%;
    list-style: none;
    padding: 0;
  }

  .cart-item {
    width: 25%;
    background-color: #fff;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    border-radius: 5px;
    margin: 10px;
    text-align: center;
    padding: 15px;
  }

  .product-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
  }

  .product-image img {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }

  .product-details {
    margin-top: 10px;
  }

  .product-details p {
    margin: 0;
  }

  .cart-empty {
    width: 100%;
    text-align: center;
    margin-top: 20px;
    color: #555;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Add click event listener to each Add to Cart button
    const addToCartButtons = document.querySelectorAll('.add-to-cart');
    addToCartButtons.forEach(button => {
      button.addEventListener('click', addToCart);
    });

    // Function to handle Add to Cart button click
    async function addToCart(event) {
      const form = event.target.closest('form');
      const formData = new FormData(form);
      const itemName = formData.get('name');

      // Send the form data to the server
      try {
        const response = await fetch('/addToCart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(Object.fromEntries(formData)),
        });

        if (response.ok) {
          const result = await response.json();

          // Check if the item is already in the cart
          const existingCartItem = document.querySelector(`.cart-item[data-name="${itemName}"]`);

          if (existingCartItem) {
            // If item already exists, increase the quantity
            const quantityElement = existingCartItem.querySelector('.quantity-value');
            const newQuantity = parseInt(quantityElement.textContent, 10) + 1;
            quantityElement.textContent = newQuantity;
          } else {
            // If item is not in the cart, add a new cart item
            const cartContainer = document.getElementById('cart-container');
            const newCartItem = document.createElement('li');
            newCartItem.className = 'cart-item';
            newCartItem.setAttribute('data-name', itemName);
            newCartItem.innerHTML = `
              <div class="product-details">
                <h2>${itemName}</h2>
                <p class="price">Price: $${formData.get('price')}</p>
                <p class="quantity">Quantity: <span class="quantity-value">1</span></p>
              </div>
            `;
            cartContainer.appendChild(newCartItem);
          }

          alert(result.message);
        } else {
          console.error('Failed to add item to cart');
        }
      } catch (error) {
        console.error('Error adding item to cart:', error);
      }
    }
  });
</script>
